<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mesa - Emisi√≥n de Vouchers</title>
  <link rel="stylesheet" href="./style.css" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#0b1220;color:#e5e7eb}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:16px;max-width:980px;margin:16px auto}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 220px}
    .label{font-size:12px;color:#9ca3af;margin-bottom:6px}
    .input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #334155;background:#111827;color:#e5e7eb}
    .button{padding:10px 14px;border-radius:8px;border:1px solid #334155;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .status{margin-top:12px;font-size:14px}
    iframe{border:1px solid #334155;border-radius:8px}
    nav .button { margin-left: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Mesa</h1>
    <nav>
       <a id="linkCaja" href="./caja.html">Caja</a>
       <button class="button" id="btnSalir">Salir</button>
    </nav>
  </header>

  <main>
    <section class="card">
      <h2>Emisi√≥n de voucher</h2>
      <div class="row">
        <div class="col">
          <div class="label">Valor</div>
          <input id="valor" class="input" type="number" min="0" step="0.01" value="335.45" />
        </div>
        <div class="col">
          <div class="label">Moneda</div>
          <select id="moneda" class="input"><option value="DOP">DOP</option><option value="USD">USD</option></select>
        </div>
        <div class="col">
          <div class="label">Mesa</div>
          <input id="mesa" class="input" value="P03" />
        </div>
        <div class="col">
          <div class="label">Emitido por</div>
          <select id="usuario" class="input">
            <option value="">Seleccione operador...</option>
          </select>
        </div>
      </div>

      <!-- Valores R√°pidos -->
      <div style="margin-top:16px">
        <div style="font-size:14px;color:#9ca3af;margin-bottom:8px">‚ö° Valores R√°pidos:</div>
        <div id="valores-rapidos" style="display:flex;gap:8px;flex-wrap:wrap">
          <!-- Botones se cargan din√°micamente -->
        </div>
      </div>

      <div style="margin-top:12px">
        <button class="button" id="emitir">Emitir voucher</button>
        <span id="status" class="status"></span>
      </div>
    </section>

    <section class="card" id="preview-section">
      <h2>Vista previa del ticket</h2>
      <div style="margin-top:12px">
        <iframe id="preview-ticket" width="420" height="640"></iframe>
      </div>
    </section>

    <!-- Panel de √öltimos Tickets Emitidos -->
    <section class="card" id="recent-tickets-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>üìã √öltimos Tickets Emitidos Hoy</h2>
        <button class="button" id="refresh-tickets" style="padding:6px 12px;font-size:12px">üîÑ Actualizar</button>
      </div>
      <div id="recent-tickets-list" style="margin-top:12px;max-height:400px;overflow-y:auto">
        <p style="color:#64748b;text-align:center">Cargando...</p>
      </div>
    </section>

    <section class="card" id="config-section" style="display:none">
      <h2>Perfil de impresi√≥n</h2>
      <div class="row">
        <div class="col">
          <div class="label">Modo</div>
          <select id="mode" class="input">
            <option value="PDF">PDF</option>
            <option value="ESCPOS">ESCPOS</option>
          </select>
        </div>
        <div class="col">
          <div class="label">Ancho (mm)</div>
          <select id="width" class="input">
            <option value="80">80</option>
            <option value="58">58</option>
          </select>
        </div>
        <div class="col">
          <div class="label">Alto (mm)</div>
          <input id="height" class="input" type="number" min="80" max="400" step="1" value="156" />
        </div>
      </div>
      <div style="margin-top:12px">
        <button class="button" id="guardar">Guardar perfil</button>
        <button class="button" id="vista">Vista previa</button>
        <button class="button" id="imprimir">Imprimir</button>
        <small style="margin-left:8px">Se guarda en el perfil del usuario de la app.</small>
      </div>
      <div style="margin-top:12px">
        <iframe id="preview" width="420" height="640"></iframe>
      </div>
    </section>
  </main>

  <footer>
    <small>Sistema TITO ¬∑ Emisi√≥n en Mesa</small>
  </footer>

  <script>
    const statusEl = document.getElementById('status');
    function msg(text, ok=true){ statusEl.textContent = text; statusEl.style.color = ok? '#10b981' : '#ef4444'; }

    // Navegaci√≥n: Salir (volver al panel)
    document.getElementById('btnSalir').addEventListener('click', async () => {
      try {
        await window.api?.backToPanel?.();
      } catch (e) {
        console.warn('backToPanel no disponible, intentando closeCurrent');
        try { await window.api?.closeCurrent?.(); } catch (_) { try { window.close(); } catch {} }
      }
    });

    // Emisi√≥n y prueba
    async function emitir(){
      const valor = parseFloat(document.getElementById('valor').value || '0');
      const moneda = document.getElementById('moneda').value || 'DOP';
      const mesaNombre = document.getElementById('mesa').value || 'P03';
      const operadorNombre = document.getElementById('usuario').value;

      // ‚úÖ VALIDACI√ìN: Operador es requerido
      if (!operadorNombre) {
        msg('‚ùå Debe seleccionar un operador', false);
        return;
      }

      // ‚úÖ VALIDACI√ìN: Valor debe ser mayor a 0
      if (valor <= 0) {
        msg('‚ùå El valor debe ser mayor a 0', false);
        return;
      }

      const mesa_id = mesaNombre; // compat: campo antiguo
      const usuario_emision = operadorNombre; // compat: campo antiguo
      try {
        if (!window.api?.generateTicket) throw new Error('API de Electron no disponible');

        // 1. Emitir voucher: enviar claves nuevas y mantener compatibilidad
        const ticketData = {
          amount: Number(valor),
          currency: String(moneda),
          mesa_nombre: mesaNombre,
          operador_nombre: operadorNombre,
          valor: Number(valor),
          moneda: String(moneda),
          mesa_id,
          usuario_emision
        };
        console.log('üì§ Enviando datos:', ticketData);
        const result = await window.api.generateTicket(ticketData);

        const code = result?.ticket?.code || result?.ticket_number;
        console.log('‚úÖ Voucher emitido:', code);

        // 2. Mostrar mensaje
        const monedaShow = result?.ticket?.currency || result?.moneda || moneda;
        const valorShow = typeof result?.ticket?.amount === 'number' ? result.ticket.amount : (result?.valor ?? valor);
        msg(`Emitido ticket ${code} (${monedaShow} ${Number(valorShow).toFixed(2)})`);

        // 3. GUARDAR datos del ticket para la vista previa
        const ticketEmitido = {
          valor: valorShow,
          moneda: monedaShow,
          mesa_nombre: mesaNombre,
          operador_nombre: operadorNombre,
          ticket_number: code
        };

        // Actualizar vista previa con datos del ticket emitido
        console.log('üîÑ Actualizando vista previa con ticket emitido:', ticketEmitido);
        await vistaPrevia(code); // Pasar el c√≥digo para generar vista previa correcta

        // 4. RESET del formulario para nuevo ticket (FIRMA DIGITAL)
        // ‚ö†Ô∏è Esperar 1500ms para asegurar que la vista previa se cargue completamente
        setTimeout(() => {
          try {
            // Vaciar valor
            const valorInput = document.getElementById('valor');
            if (valorInput) valorInput.value = '';

            // Resetear operador (FIRMA DIGITAL - debe elegir cada vez)
            const usuarioSelect = document.getElementById('usuario');
            if (usuarioSelect) usuarioSelect.value = '';

            // NO resetear mesa ni moneda - mantener contexto

            // ‚úÖ FIX: NO actualizar vista previa despu√©s del reset
            // La vista previa debe quedarse mostrando el ticket emitido
            // actualizarVistaPrevia(); ‚Üê ELIMINADO

            console.log('‚úÖ Formulario reseteado para nuevo ticket');
          } catch (resetError) {
            console.warn('‚ö†Ô∏è Error reseteando formulario:', resetError);
          }
        }, 1500); // 1.5 segundos para dar tiempo a la vista previa

      } catch(e) {
        console.error(e); msg(`Error: ${e.message}`, false);
      }
    }


    // Perfil de impresi√≥n
    const modeEl = document.getElementById('mode');
    const widthEl = document.getElementById('width');
    const heightEl = document.getElementById('height');
    const previewEl = document.getElementById('preview');
    const previewTicketEl = document.getElementById('preview-ticket');

    async function cargarPerfil(){
      try {
        const resp = await window.api?.getPrintProfile?.();
        const cur = resp?.current || { mode:'PDF', width_mm:80, height_mm:156 };
        modeEl.value = (cur.mode || 'PDF').toUpperCase();
        widthEl.value = String(cur.width_mm || 80);
        heightEl.value = Number(cur.height_mm || 156);
      } catch(e) { console.warn('Sin IPC, usando valores por defecto'); }
    }
    async function guardarPerfil(){
      const payload = { mode: modeEl.value, width_mm: Number(widthEl.value), height_mm: Number(heightEl.value) };
      try {
        const resp = await window.api?.setPrintProfile?.(payload);
        if (resp?.success) msg(`Perfil guardado: ${resp.current.mode} ${resp.current.width_mm}x${resp.current.height_mm}mm`);
        else msg('Perfil actualizado localmente');
      } catch(e) { msg(`Error guardando perfil: ${e.message}`, false); }
    }
    async function vistaPrevia(voucherCode = null, datosTicket = null){
      try {
        // Si se pasan datos del ticket, usarlos; sino, leer del formulario
        const valor = datosTicket?.valor || parseFloat(document.getElementById('valor').value || '0');
        const moneda = datosTicket?.moneda || document.getElementById('moneda').value || 'DOP';
        const mesa_id = datosTicket?.mesa_nombre || document.getElementById('mesa').value || 'P01';
        const usuario_emision = datosTicket?.operador_nombre || document.getElementById('usuario').value || 'VistaPrevia';

        const payload = {
          valor,
          moneda,
          mesa_id,
          usuario_emision,
          pageWidthMm: Number(widthEl?.value || 80),
          pageHeightMm: Number(heightEl?.value || 156)
        };

        // Si se proporciona un c√≥digo de voucher, usarlo
        if (voucherCode) {
          payload.ticket_number = voucherCode;
          console.log('üìÑ Vista previa con c√≥digo:', voucherCode);
        }

        // ‚ö†Ô∏è FIX: A√±adir timeout para evitar bloqueos si el handler no responde
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Timeout en getTicketPreview')), 3000)
        );

        try {
          const resp = await Promise.race([
            window.api?.getTicketPreview?.(payload),
            timeoutPromise
          ]);

          if (resp?.success && resp.dataUrl && previewTicketEl) {
            previewTicketEl.src = resp.dataUrl;
            console.log('‚úÖ Vista previa actualizada:', resp.voucher_code || 'sin c√≥digo');
            return; // Salir si tuvo √©xito
          }
        } catch (apiError) {
          console.warn('‚ö†Ô∏è API getTicketPreview no disponible o timeout:', apiError.message);
        }

        // Fallback: usar URL directa
        const qs = new URLSearchParams({
          valor: String(valor || '123.45'),
          moneda,
          ancho: String(widthEl?.value || '80'),
          alto: String(heightEl?.value || '156'),
          mesa_id,
          usuario_emision,
          ticket_number: voucherCode || ''
        });
        if (previewTicketEl) {
          previewTicketEl.src = `http://localhost:8088/voucher.pdf?${qs.toString()}`;
          console.log('üìÑ Usando fallback URL para vista previa');
        }
      } catch(e) {
        console.warn('Vista previa fallback error:', e.message);
      }
    }
    // Vista previa directa en Mesa seg√∫n valor/moneda (altura autom√°tica)
    async function actualizarVistaPrevia(voucherCode = null){
      try { await vistaPrevia(voucherCode); } catch(e) { console.warn('Actualizar vista previa fall√≥:', e.message); }
    }

    function imprimir(){
      try {
        // Intentar imprimir el contenido del iframe (visor PDF)
        const win = previewEl.contentWindow;
        if (win && typeof win.print === 'function') {
          win.focus();
          win.print();
          return;
        }
      } catch (_) {}
      // Fallback: abrir en una nueva ventana y disparar print
      const src = previewEl?.src;
      if (!src) { msg('Primero genera la vista previa', false); return; }
      const w = window.open(src, '_blank');
      if (!w) { msg('No se pudo abrir la vista para imprimir', false); return; }
      const trigger = () => { try { w.focus(); w.print(); } catch (e) { msg('No se pudo imprimir: ' + e.message, false); } };
      try { w.addEventListener('load', trigger); } catch (_) {}
      setTimeout(trigger, 800); // por si el visor PDF no dispara load
    }

    document.getElementById('emitir').addEventListener('click', emitir);

    document.getElementById('guardar').addEventListener('click', guardarPerfil);
    document.getElementById('vista').addEventListener('click', vistaPrevia);
    document.getElementById('imprimir').addEventListener('click', imprimir);

    // ============================================
    // CARGAR OPERADORES desde Supabase
    // ============================================
    async function cargarOperadores() {
      try {
        console.log('üìã Cargando operadores activos...');
        const result = await window.api?.invoke?.('get-operadores-activos');

        if (!result) {
          console.warn('‚ö†Ô∏è API no disponible - modo offline');
          return;
        }

        if (result.success && result.operadores) {
          const select = document.getElementById('usuario');

          // Limpiar opciones anteriores
          select.innerHTML = '<option value="">Seleccione operador...</option>';

          // Agregar operadores activos
          result.operadores.forEach(op => {
            const option = document.createElement('option');
            option.value = op.nombre; // Guardamos el nombre para el ticket
            option.textContent = op.nombre;
            select.appendChild(option);
          });

          console.log(`‚úÖ ${result.operadores.length} operadores cargados`);
        } else {
          console.warn('‚ö†Ô∏è No se pudieron cargar operadores:', result?.error);
        }
      } catch (error) {
        console.error('‚ùå Error cargando operadores:', error);
      }
    }

    // Init
    cargarPerfil().then(vistaPrevia);
    actualizarVistaPrevia();
    cargarOperadores(); // Cargar operadores al iniciar

    ['valor','moneda','mesa','usuario'].forEach(id => {
      const el = document.getElementById(id);
      el?.addEventListener('input', actualizarVistaPrevia);
      el?.addEventListener('change', actualizarVistaPrevia);
    });

    // Restricciones por rol: ocultar Caja y/o Configuraci√≥n
    (async () => {
      try {
        const role = String(await (window.api?.getRole?.() || Promise.resolve('MESA'))).toUpperCase();
        // Mesa no puede acceder a Caja
        if (role === 'MESA') {
          document.getElementById('linkCaja')?.setAttribute('style','display:none');
        }
        // Auditor no puede acceder a Configuraci√≥n
        if (role === 'AUDITOR') {
          document.getElementById('config-section')?.setAttribute('style','display:none');
        }
      } catch (e) {
        console.warn('Restricciones por rol no aplicadas:', e.message);
      }
    })();

    // Funci√≥n para establecer valor r√°pido
    function setValorRapido(valor) {
      const valorInput = document.getElementById('valor');
      if (valorInput) {
        valorInput.value = valor;
        console.log(`‚ö° Valor r√°pido establecido: ${valor}`);

        // ‚ö†Ô∏è FIX: Actualizar vista previa de forma as√≠ncrona para no bloquear UI
        setTimeout(() => {
          actualizarVistaPrevia().catch(err => {
            console.warn('‚ö†Ô∏è Error actualizando vista previa:', err.message);
          });
        }, 0);
      }
    }

    // Cargar valores r√°pidos desde configuraci√≥n
    async function cargarValoresRapidos() {
      try {
        const result = await window.api?.invoke?.('currency:get-config');
        if (result?.success && result?.config) {
          const moneda = document.getElementById('moneda').value || 'DOP';
          const config = result.config[moneda];

          if (config && config.presets && Array.isArray(config.presets)) {
            const container = document.getElementById('valores-rapidos');
            if (container) {
              container.innerHTML = '';
              config.presets.forEach(valor => {
                const btn = document.createElement('button');
                btn.className = 'button';
                btn.style.cssText = 'padding:6px 12px;font-size:13px;background:#3b82f6;border-color:#3b82f6;';
                btn.textContent = `${moneda === 'USD' ? '$' : 'RD$'}${Number(valor).toLocaleString()}`;
                btn.onclick = () => setValorRapido(valor);
                container.appendChild(btn);
              });
              console.log(`‚úÖ Valores r√°pidos cargados: ${config.presets.length} opciones`);
            }
          }
        } else {
          // Valores por defecto si no hay configuraci√≥n
          cargarValoresPorDefecto();
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Error cargando valores r√°pidos:', error);
        cargarValoresPorDefecto();
      }
    }

    // Valores por defecto si no hay configuraci√≥n
    function cargarValoresPorDefecto() {
      const moneda = document.getElementById('moneda').value || 'DOP';
      const presets = moneda === 'USD'
        ? [20, 50, 100, 200, 500, 1000]
        : [100, 500, 1000, 2000, 5000, 10000];

      const container = document.getElementById('valores-rapidos');
      if (container) {
        container.innerHTML = '';
        presets.forEach(valor => {
          const btn = document.createElement('button');
          btn.className = 'button';
          btn.style.cssText = 'padding:6px 12px;font-size:13px;background:#3b82f6;border-color:#3b82f6;';
          btn.textContent = `${moneda === 'USD' ? '$' : 'RD$'}${Number(valor).toLocaleString()}`;
          btn.onclick = () => setValorRapido(valor);
          container.appendChild(btn);
        });
      }
    }

    // Recargar valores r√°pidos al cambiar moneda
    document.getElementById('moneda').addEventListener('change', () => {
      cargarValoresRapidos();
    });

    // Cargar valores r√°pidos al inicio
    cargarValoresRapidos();

    // Sistema de salud anti-cuelgues: cargar indicador visual
    (async function cargarIndicadorSalud() {
      try {
        const response = await fetch('health-indicator.html');
        const html = await response.text();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        // Insertar todos los elementos del indicador en el body
        while (tempDiv.firstChild) {
          document.body.appendChild(tempDiv.firstChild);
        }
        console.log('‚úÖ Indicador de salud cargado');
      } catch (e) {
        console.warn('‚ùå No se pudo cargar indicador de salud:', e.message);
      }
    })();

    // ============================================
    // PANEL DE √öLTIMOS TICKETS RECIENTES
    // ============================================
    async function loadRecentTickets() {
      const listEl = document.getElementById('recent-tickets-list');
      if (!listEl) return;

      try {
        listEl.innerHTML = '<p style="color:#64748b;text-align:center">Cargando...</p>';

        const result = await window.api.getRecentTickets(20);

        if (!result.success || !result.tickets || result.tickets.length === 0) {
          listEl.innerHTML = '<p style="color:#64748b;text-align:center">No hay tickets emitidos hoy</p>';
          return;
        }

        // Renderizar tickets
        listEl.innerHTML = result.tickets.map(t => `
          <div style="padding:12px;border:1px solid #1f2740;border-radius:8px;margin-bottom:8px;background:#0f1731;transition:background 0.2s">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <strong style="color:#2e7de9;font-size:14px">${t.code}</strong>
              <span style="
                font-size:12px;
                padding:4px 8px;
                border-radius:4px;
                background:${t.estado === 'Cobrado' ? '#7bc37933' : t.estado === 'Pendiente' ? '#e3b34133' : '#e35d5d33'};
                color:${t.estado === 'Cobrado' ? '#7bc379' : t.estado === 'Pendiente' ? '#e3b341' : '#e35d5d'}
              ">${t.estado}</span>
            </div>
            <div style="font-size:13px;color:#a9b3c7;margin-bottom:4px">
              üé∞ ${t.mesa} ¬∑ üë§ ${t.operador}
            </div>
            <div style="font-size:18px;font-weight:600;color:#ffffff">
              ${t.currency} ${Number(t.amount).toFixed(2)}
            </div>
            <div style="font-size:11px;color:#64748b;margin-top:4px">
              ${new Date(t.fecha).toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' })}
            </div>
          </div>
        `).join('');

        console.log(`‚úÖ ${result.tickets.length} tickets recientes cargados`);
      } catch (error) {
        console.error('Error cargando tickets recientes:', error);
        listEl.innerHTML = '<p style="color:#ef4444;text-align:center">‚ùå Error cargando tickets</p>';
      }
    }

    // Cargar tickets al iniciar
    loadRecentTickets();

    // Bot√≥n refrescar
    const refreshBtn = document.getElementById('refresh-tickets');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        console.log('üîÑ Refrescando tickets...');
        loadRecentTickets();
      });
    }

    // Auto-refrescar despu√©s de emitir ticket
    // Envolver la funci√≥n emitir original para agregar hook
    const originalEmitir = window.emitir;
    if (originalEmitir) {
      window.emitir = async function(...args) {
        const result = await originalEmitir.apply(this, args);
        // Refrescar panel despu√©s de 1 segundo
        setTimeout(() => {
          console.log('üîÑ Auto-refrescando panel de tickets...');
          loadRecentTickets();
        }, 1000);
        return result;
      };
    }
  </script>
</body>
</html>
