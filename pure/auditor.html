<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auditor√≠a - Solo Lectura</title>
  <link rel="stylesheet" href="./style.css" />

  <!-- jsPDF para generaci√≥n de PDFs - versi√≥n local -->
  <script src="../node_modules/jspdf/dist/jspdf.umd.min.js"></script>
  <script src="../node_modules/jspdf-autotable/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#0b1220;color:#e5e7eb;margin:0;padding:0}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:16px;margin:16px auto;max-width:1400px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px}
    .stat-card{background:#111827;border:1px solid #334155;border-radius:8px;padding:16px;text-align:center}
    .stat-value{font-size:28px;font-weight:700;margin:8px 0}
    .stat-label{font-size:13px;color:#9ca3af;text-transform:uppercase}
    .stat-card.success .stat-value{color:#10b981}
    .stat-card.warning .stat-value{color:#f59e0b}
    .stat-card.danger .stat-value{color:#ef4444}
    .stat-card.info .stat-value{color:#3b82f6}
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px}
    .input,.select{width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#111827;color:#e5e7eb;font-size:14px}
    .button{padding:10px 16px;border-radius:8px;border:1px solid #334155;background:#1f2937;color:#e5e7eb;cursor:pointer;font-size:14px;font-weight:500}
    .button:hover{background:#2d3748}
    .button.primary{background:#3b82f6;border-color:#3b82f6}
    .button.primary:hover{background:#2563eb}
    .button.success{background:#10b981;border-color:#10b981}
    .button.success:hover{background:#059669}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    thead{background:#111827;position:sticky;top:0;z-index:10}
    th{padding:12px;text-align:left;border-bottom:2px solid #334155;font-weight:600;font-size:13px;text-transform:uppercase;color:#9ca3af}
    td{padding:12px;border-bottom:1px solid #1f2937;font-size:14px}
    tbody tr:hover{background:#111827}
    .badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;text-transform:uppercase}
    .badge.emitido,.badge.active,.badge.activo{background:#10b98120;color:#10b981}
    .badge.canjeado,.badge.redeemed{background:#3b82f620;color:#3b82f6}
    .badge.cancelado,.badge.cancelled{background:#ef444420;color:#ef4444}
    .pagination{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:20px}
    .pagination button{padding:8px 12px;border-radius:6px;border:1px solid #334155;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .pagination button:hover:not(:disabled){background:#2d3748}
    .pagination button:disabled{opacity:0.5;cursor:not-allowed}
    .pagination .current{background:#3b82f6;border-color:#3b82f6;font-weight:600}
    .status-message{margin:16px 0;padding:12px;border-radius:8px;font-size:14px}
    .status-message.success{background:#10b98120;color:#10b981;border:1px solid #10b981}
    .status-message.error{background:#ef444420;color:#ef4444;border:1px solid #ef4444}
    .status-message.info{background:#3b82f620;color:#3b82f6;border:1px solid #3b82f6}
    .readonly-badge{display:inline-block;background:#f59e0b20;color:#f59e0b;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-left:12px}
    .table-container{overflow-x:auto;max-height:600px;overflow-y:auto}
    .empty-state{text-align:center;padding:60px 20px;color:#6b7280}
    .empty-state svg{width:64px;height:64px;margin-bottom:16px;opacity:0.5}
  </style>
</head>
<body>
  <header style="background:#0f172a;border-bottom:1px solid #1f2937;padding:16px 24px;display:flex;justify-content:space-between;align-items:center">
    <div>
      <h1 style="margin:0;font-size:24px">üìä Auditor√≠a <span class="readonly-badge">üîí Solo Lectura</span></h1>
      <p style="margin:4px 0 0 0;color:#9ca3af;font-size:14px">Vista completa de tickets y estad√≠sticas del sistema</p>
    </div>
    <nav>
      <button class="button" id="btnVolver">‚Üê Volver al Panel</button>
    </nav>
  </header>

  <main style="padding:0 24px 24px 24px">
    <!-- Estad√≠sticas del D√≠a -->
    <section class="card">
      <h2 style="margin-top:0">Estad√≠sticas del D√≠a</h2>
      <div id="status-message"></div>
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card info">
          <div class="stat-label">Total Tickets</div>
          <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Emitidos</div>
          <div class="stat-value" id="stat-emitidos">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Canjeados</div>
          <div class="stat-value" id="stat-canjeados">0</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-label">Pendientes</div>
          <div class="stat-value" id="stat-pendientes">0</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Total DOP</div>
          <div class="stat-value" id="stat-total-dop">$0.00</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Total USD</div>
          <div class="stat-value" id="stat-total-usd">$0.00</div>
        </div>
      </div>
    </section>

    <!-- Filtros -->
    <section class="card">
      <h2 style="margin-top:0">Filtros de B√∫squeda</h2>
      <div class="filters">
        <div>
          <label style="font-size:12px;color:#9ca3af;display:block;margin-bottom:4px">Fecha Desde</label>
          <input type="date" id="filtro-desde" class="input" />
        </div>
        <div>
          <label style="font-size:12px;color:#9ca3af;display:block;margin-bottom:4px">Fecha Hasta</label>
          <input type="date" id="filtro-hasta" class="input" />
        </div>
        <div>
          <label style="font-size:12px;color:#9ca3af;display:block;margin-bottom:4px">Estado</label>
          <select id="filtro-estado" class="input">
            <option value="">Todos</option>
            <option value="emitido">Emitido</option>
            <option value="active">Active</option>
            <option value="canjeado">Canjeado</option>
            <option value="redeemed">Redeemed</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
        <div>
          <label style="font-size:12px;color:#9ca3af;display:block;margin-bottom:4px">Moneda</label>
          <select id="filtro-moneda" class="input">
            <option value="">Todas</option>
            <option value="DOP">DOP</option>
            <option value="USD">USD</option>
          </select>
        </div>
        <div>
          <label style="font-size:12px;color:#9ca3af;display:block;margin-bottom:4px">Mesa</label>
          <input type="text" id="filtro-mesa" class="input" placeholder="Ej: P01" />
        </div>
        <div>
          <label style="font-size:12px;color:#9ca3af;display:block;margin-bottom:4px">Operador</label>
          <input type="text" id="filtro-operador" class="input" placeholder="Nombre" />
        </div>
      </div>
      <div style="display:flex;gap:12px;margin-top:16px">
        <button class="button primary" id="btnBuscar">üîç Buscar</button>
        <button class="button" id="btnLimpiar">üîÑ Limpiar Filtros</button>
        <button class="button success" id="btnExportar" style="margin-left:auto">üì• Exportar a CSV</button>
        <button class="button" id="btnVerPDF" style="background:#dc2626;border-color:#dc2626">üìÑ Ver PDF</button>
        <button class="button" id="btnImprimirPDF" style="background:#7c3aed;border-color:#7c3aed">üñ®Ô∏è Imprimir PDF</button>
      </div>
    </section>

    <!-- Tabla de Tickets -->
    <section class="card">
      <h2 style="margin-top:0">Listado de Tickets</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Monto</th>
              <th>Moneda</th>
              <th>Estado</th>
              <th>Mesa</th>
              <th>Operador</th>
              <th>Fecha Emisi√≥n</th>
              <th>Fecha Canje</th>
            </tr>
          </thead>
          <tbody id="tabla-tickets">
            <tr>
              <td colspan="8" class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <div style="font-size:16px;font-weight:600">No hay tickets para mostrar</div>
                <div style="font-size:14px;margin-top:8px">Aplica filtros o busca sin filtros para ver todos los tickets</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginaci√≥n -->
      <div class="pagination" id="pagination">
        <button id="btn-primera">¬´</button>
        <button id="btn-anterior">‚Äπ</button>
        <span style="color:#9ca3af;font-size:14px;margin:0 12px" id="page-info">P√°gina 0 de 0</span>
        <button id="btn-siguiente">‚Ä∫</button>
        <button id="btn-ultima">¬ª</button>
      </div>
    </section>
  </main>

  <footer style="text-align:center;padding:20px;color:#6b7280;font-size:13px;border-top:1px solid #1f2937">
    <small>Sistema TITO ¬∑ M√≥dulo de Auditor√≠a (Solo Lectura)</small>
  </footer>

  <script>
    let currentPage = 1;
    let totalPages = 1;
    let currentFilters = {};

    // ============================================
    // CARGAR ESTAD√çSTICAS
    // ============================================
    async function cargarEstadisticas() {
      try {
        console.log('üìä [Frontend] Llamando a get-audit-stats...');

        if (!window.api || !window.api.invoke) {
          console.error('‚ùå [Frontend] window.api no est√° disponible');
          mostrarMensaje('‚ùå API de Electron no disponible', 'error');
          return;
        }

        const result = await window.api.invoke('get-audit-stats');
        console.log('üìä [Frontend] Respuesta de get-audit-stats:', result);

        if (!result) {
          console.error('‚ùå [Frontend] Respuesta vac√≠a');
          mostrarMensaje('‚ö†Ô∏è API retorn√≥ respuesta vac√≠a', 'error');
          return;
        }

        if (result.success && result.stats) {
          const s = result.stats;
          console.log('üìä [Frontend] Estad√≠sticas recibidas:', s);

          document.getElementById('stat-total').textContent = s.total || 0;
          document.getElementById('stat-emitidos').textContent = s.emitidos || 0;
          document.getElementById('stat-canjeados').textContent = s.canjeados || 0;
          document.getElementById('stat-pendientes').textContent = s.pendientes || 0;
          document.getElementById('stat-total-dop').textContent = `$${s.totalDOP || '0.00'}`;
          document.getElementById('stat-total-usd').textContent = `$${s.totalUSD || '0.00'}`;

          mostrarMensaje(`‚úÖ Estad√≠sticas cargadas desde ${result.source} - ${s.total} tickets`, 'success');
        } else {
          console.error('‚ùå [Frontend] Error en respuesta:', result.error);
          mostrarMensaje('‚ùå Error: ' + (result.error || 'Desconocido'), 'error');
        }
      } catch (error) {
        console.error('‚ùå [Frontend] Excepci√≥n cargando estad√≠sticas:', error);
        console.error('‚ùå [Frontend] Stack:', error.stack);
        mostrarMensaje('‚ùå Error cargando estad√≠sticas: ' + error.message, 'error');
      }
    }

    // ============================================
    // CARGAR TICKETS CON FILTROS
    // ============================================
    async function cargarTickets(page = 1) {
      try {
        console.log('üìã [Frontend] Llamando a get-audit-tickets...');
        console.log('üìã [Frontend] P√°gina solicitada:', page);
        console.log('üìã [Frontend] Filtros actuales:', JSON.stringify(currentFilters, null, 2));

        if (!window.api || !window.api.invoke) {
          console.error('‚ùå [Frontend] window.api no est√° disponible');
          mostrarMensaje('‚ùå API de Electron no disponible', 'error');
          return;
        }

        const parametros = {
          ...currentFilters,
          page,
          limit: 20
        };
        console.log('üìã [Frontend] Par√°metros enviados:', JSON.stringify(parametros, null, 2));

        const result = await window.api.invoke('get-audit-tickets', parametros);
        console.log('üìã [Frontend] Respuesta de get-audit-tickets:', result);

        if (!result) {
          console.error('‚ùå [Frontend] Respuesta vac√≠a');
          mostrarMensaje('‚ö†Ô∏è API retorn√≥ respuesta vac√≠a', 'error');
          return;
        }

        if (result.success && result.tickets) {
          console.log(`üìã [Frontend] Tickets recibidos: ${result.tickets.length} de ${result.total} totales`);
          console.log('üìã [Frontend] Fuente de datos:', result.source);
          console.log('üìã [Frontend] P√°gina actual:', result.page, 'Total p√°ginas:', result.totalPages);
          console.log('üìã [Frontend] Primeros 3 tickets:', result.tickets.slice(0, 3));

          mostrarTickets(result.tickets);
          currentPage = result.page;
          totalPages = result.totalPages;
          actualizarPaginacion();
          mostrarMensaje(`‚úÖ ${result.tickets.length} tickets cargados de ${result.total} totales desde ${result.source}`, 'success');
        } else {
          console.error('‚ùå [Frontend] Error en respuesta:', result.error);
          console.error('‚ùå [Frontend] Respuesta completa:', JSON.stringify(result, null, 2));
          mostrarMensaje('‚ùå Error: ' + (result.error || 'Desconocido'), 'error');
        }
      } catch (error) {
        console.error('‚ùå [Frontend] Excepci√≥n cargando tickets:', error);
        console.error('‚ùå [Frontend] Stack:', error.stack);
        mostrarMensaje('‚ùå Error cargando tickets: ' + error.message, 'error');
      }
    }

    // ============================================
    // MOSTRAR TICKETS EN TABLA
    // ============================================
    function mostrarTickets(tickets) {
      console.log('üé® [Frontend] Mostrando tickets en tabla...');
      console.log('üé® [Frontend] Cantidad de tickets a mostrar:', tickets.length);

      const tbody = document.getElementById('tabla-tickets');

      if (!tbody) {
        console.error('‚ùå [Frontend] Elemento tabla-tickets no encontrado en DOM');
        return;
      }

      if (tickets.length === 0) {
        console.log('‚ö†Ô∏è [Frontend] Sin tickets para mostrar - mostrando estado vac√≠o');
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <div style="font-size:16px;font-weight:600">No se encontraron tickets</div>
              <div style="font-size:14px;margin-top:8px">Intenta con otros filtros o fechas</div>
            </td>
          </tr>
        `;
        return;
      }

      console.log('üé® [Frontend] Renderizando', tickets.length, 'filas en tabla');

      tbody.innerHTML = tickets.map((t, index) => {
        const estado = (t.estado || t.status || 'desconocido').toLowerCase();
        const badgeClass = estado.includes('emit') || estado.includes('activ') ? 'badge emitido' :
                          estado.includes('canje') || estado.includes('redeem') ? 'badge canjeado' :
                          estado.includes('cancel') ? 'badge cancelado' : 'badge';

        if (index === 0) {
          console.log('üé® [Frontend] Ejemplo de ticket renderizado:', {
            code: t.code,
            amount: t.amount,
            currency: t.currency,
            estado: estado,
            mesa: t.mesa,
            operador: t.operador,
            created_at: t.created_at
          });
        }

        return `
          <tr>
            <td><strong>${t.code}</strong></td>
            <td><strong>${Number(t.amount).toFixed(2)}</strong></td>
            <td>${t.currency}</td>
            <td><span class="${badgeClass}">${estado}</span></td>
            <td>${t.mesa || 'N/A'}</td>
            <td>${t.operador || 'N/A'}</td>
            <td>${formatFecha(t.created_at)}</td>
            <td>${t.used_at ? formatFecha(t.used_at) : '-'}</td>
          </tr>
        `;
      }).join('');

      console.log('‚úÖ [Frontend] Tabla renderizada con', tickets.length, 'tickets');
    }

    // ============================================
    // ACTUALIZAR PAGINACI√ìN
    // ============================================
    function actualizarPaginacion() {
      document.getElementById('page-info').textContent = `P√°gina ${currentPage} de ${totalPages}`;
      document.getElementById('btn-primera').disabled = currentPage === 1;
      document.getElementById('btn-anterior').disabled = currentPage === 1;
      document.getElementById('btn-siguiente').disabled = currentPage === totalPages;
      document.getElementById('btn-ultima').disabled = currentPage === totalPages;
    }

    // ============================================
    // EXPORTAR A CSV
    // ============================================
    async function exportarReporte() {
      try {
        console.log('üì• [Frontend] Llamando a export-audit-report...');
        console.log('üì• [Frontend] Filtros para exportar:', JSON.stringify(currentFilters, null, 2));
        mostrarMensaje('üì• Generando reporte...', 'info');

        if (!window.api || !window.api.invoke) {
          console.error('‚ùå [Frontend] window.api no est√° disponible');
          mostrarMensaje('‚ùå API de Electron no disponible', 'error');
          return;
        }

        const result = await window.api.invoke('export-audit-report', currentFilters);
        console.log('üì• [Frontend] Respuesta de export-audit-report:', result);

        if (!result) {
          console.error('‚ùå [Frontend] Respuesta vac√≠a');
          mostrarMensaje('‚ö†Ô∏è API retorn√≥ respuesta vac√≠a', 'error');
          return;
        }

        if (result.success) {
          console.log('‚úÖ [Frontend] Reporte exportado exitosamente');
          console.log('üì• [Frontend] Archivo:', result.filename);
          console.log('üì• [Frontend] Ruta completa:', result.filepath);
          console.log('üì• [Frontend] Registros exportados:', result.totalRecords);

          mostrarMensaje(`‚úÖ Reporte exportado: ${result.filename} (${result.totalRecords} registros)`, 'success');

          // Abrir ubicaci√≥n del archivo
          if (result.filepath) {
            console.log('üìÇ [Frontend] Abriendo ubicaci√≥n del archivo...');
            await window.api.invoke('open-file-location', result.filepath);
          }
        } else {
          console.error('‚ùå [Frontend] Error en exportaci√≥n:', result.error);
          mostrarMensaje('‚ùå Error exportando: ' + (result.error || 'Desconocido'), 'error');
        }
      } catch (error) {
        console.error('‚ùå [Frontend] Excepci√≥n exportando reporte:', error);
        console.error('‚ùå [Frontend] Stack:', error.stack);
        mostrarMensaje('‚ùå Error al exportar reporte: ' + error.message, 'error');
      }
    }

    // ============================================
    // UTILIDADES
    // ============================================
    function formatFecha(fecha) {
      if (!fecha) return '-';
      const d = new Date(fecha);
      return d.toLocaleString('es-DO', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function mostrarMensaje(texto, tipo = 'info') {
      const div = document.getElementById('status-message');
      div.className = `status-message ${tipo}`;
      div.textContent = texto;
      div.style.display = 'block';
      setTimeout(() => {
        div.style.display = 'none';
      }, 5000);
    }

    // ============================================
    // GENERACI√ìN DE PDF
    // ============================================
    async function generarPDF() {
      try {
        console.log('üìÑ Generando PDF del reporte de auditor√≠a...');

        // ‚úÖ VERIFICAR que jsPDF est√© cargado
        if (!window.jspdf) {
          console.error('‚ùå jsPDF no est√° cargado. Verifica la conexi√≥n a internet o CDN.');
          mostrarMensaje('‚ùå Error: Librer√≠as PDF no disponibles. Verifica tu conexi√≥n.', 'error');
          return null;
        }

        // Leer filtros actuales de los inputs (como lo hace btnBuscar)
        const filtrosActuales = {
          fechaDesde: document.getElementById('filtro-desde').value || undefined,
          fechaHasta: document.getElementById('filtro-hasta').value || undefined,
          estado: document.getElementById('filtro-estado').value || undefined,
          moneda: document.getElementById('filtro-moneda').value || undefined,
          mesa: document.getElementById('filtro-mesa').value || undefined,
          operador: document.getElementById('filtro-operador').value || undefined,
          page: 1,
          limit: 10000 // Sin l√≠mite para el PDF
        };

        console.log('üìÑ Filtros para PDF:', filtrosActuales);

        // Obtener tickets filtrados
        const result = await window.api.invoke('get-audit-tickets', filtrosActuales);

        if (!result.success || !result.tickets || result.tickets.length === 0) {
          mostrarMensaje('‚ö†Ô∏è No hay tickets para generar el PDF', 'error');
          return null;
        }

        const tickets = result.tickets;
        console.log(`üìÑ ${tickets.length} tickets obtenidos para PDF`);

        // Obtener estad√≠sticas
        const statsResult = await window.api.invoke('get-audit-stats');
        const stats = statsResult.success ? statsResult.stats : {};

        // Crear documento PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        console.log('‚úÖ Documento PDF creado');

        // ===== T√çTULO =====
        doc.setFontSize(18);
        doc.setTextColor(37, 99, 235); // Azul
        doc.text('Reporte de Auditor√≠a - Sistema TITO', 20, 20);

        // ===== FECHA Y FILTROS =====
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        const fechaGeneracion = new Date().toLocaleString('es-DO', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        doc.text(`Generado: ${fechaGeneracion}`, 20, 30);

        // Mostrar filtros aplicados
        let yPos = 35;
        if (filtrosActuales.fechaDesde || filtrosActuales.fechaHasta) {
          const desde = filtrosActuales.fechaDesde || 'Inicio';
          const hasta = filtrosActuales.fechaHasta || 'Hoy';
          doc.text(`Per√≠odo: ${desde} al ${hasta}`, 20, yPos);
          yPos += 5;
        }
        if (filtrosActuales.estado) {
          doc.text(`Estado: ${filtrosActuales.estado}`, 20, yPos);
          yPos += 5;
        }
        if (filtrosActuales.moneda) {
          doc.text(`Moneda: ${filtrosActuales.moneda}`, 20, yPos);
          yPos += 5;
        }

        // ===== ESTAD√çSTICAS =====
        yPos += 5;
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text('Estad√≠sticas:', 20, yPos);
        yPos += 7;

        doc.setFontSize(10);
        doc.setTextColor(60, 60, 60);
        doc.text(`Total Tickets: ${stats.total || tickets.length}`, 20, yPos);
        doc.text(`Emitidos: ${stats.emitidos || 0}`, 80, yPos);
        doc.text(`Canjeados: ${stats.canjeados || 0}`, 130, yPos);
        yPos += 6;
        doc.text(`Total DOP: $${stats.totalDOP || '0.00'}`, 20, yPos);
        doc.text(`Total USD: $${stats.totalUSD || '0.00'}`, 80, yPos);
        yPos += 10;

        // ===== TABLA DE TICKETS =====
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text('Listado de Tickets:', 20, yPos);
        yPos += 5;

        // Preparar datos para la tabla
        const tableData = tickets.map(ticket => [
          ticket.code || 'N/A',
          `${ticket.currency || ''} $${Number(ticket.amount || 0).toFixed(2)}`,
          ticket.estado || 'N/A',
          ticket.mesa || 'N/A',
          ticket.operador || 'N/A',
          formatFecha(ticket.created_at) || 'N/A',
          ticket.used_at ? formatFecha(ticket.used_at) : '-'
        ]);

        doc.autoTable({
          startY: yPos,
          head: [['C√≥digo', 'Monto', 'Estado', 'Mesa', 'Operador', 'Emisi√≥n', 'Canje']],
          body: tableData,
          styles: {
            fontSize: 8,
            cellPadding: 3
          },
          headStyles: {
            fillColor: [37, 99, 235],
            textColor: 255,
            fontStyle: 'bold'
          },
          alternateRowStyles: {
            fillColor: [245, 247, 250]
          },
          margin: { left: 20, right: 20 }
        });

        // ===== FOOTER =====
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(150, 150, 150);
          doc.text(
            `P√°gina ${i} de ${pageCount} - Sistema TITO Casino`,
            doc.internal.pageSize.getWidth() / 2,
            doc.internal.pageSize.getHeight() - 10,
            { align: 'center' }
          );
        }

        console.log('‚úÖ PDF generado correctamente');
        return doc;

      } catch (error) {
        console.error('‚ùå Error al generar PDF:', error);
        mostrarMensaje(`‚ùå Error al generar PDF: ${error.message}`, 'error');
        return null;
      }
    }

    async function verPDF() {
      const doc = await generarPDF();
      if (!doc) return;

      try {
        // Convertir a blob y abrir en nueva pesta√±a
        const blob = doc.output('blob');
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        mostrarMensaje('‚úÖ PDF abierto en nueva pesta√±a', 'success');
      } catch (error) {
        console.error('‚ùå Error al abrir PDF:', error);
        mostrarMensaje(`‚ùå Error al abrir PDF: ${error.message}`, 'error');
      }
    }

    async function imprimirPDF() {
      const doc = await generarPDF();
      if (!doc) return;

      try {
        // Generar blob y abrir di√°logo de impresi√≥n
        const blob = doc.output('blob');
        const url = URL.createObjectURL(blob);

        // Crear iframe oculto para imprimir
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);

        iframe.onload = function() {
          iframe.contentWindow.print();
          mostrarMensaje('‚úÖ Enviando a impresora...', 'success');

          // Limpiar despu√©s de imprimir
          setTimeout(() => {
            document.body.removeChild(iframe);
            URL.revokeObjectURL(url);
          }, 1000);
        };
      } catch (error) {
        console.error('‚ùå Error al imprimir PDF:', error);
        mostrarMensaje(`‚ùå Error al imprimir PDF: ${error.message}`, 'error');
      }
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.getElementById('btnBuscar').addEventListener('click', () => {
      currentFilters = {
        fechaDesde: document.getElementById('filtro-desde').value || undefined,
        fechaHasta: document.getElementById('filtro-hasta').value || undefined,
        estado: document.getElementById('filtro-estado').value || undefined,
        moneda: document.getElementById('filtro-moneda').value || undefined,
        mesa: document.getElementById('filtro-mesa').value || undefined,
        operador: document.getElementById('filtro-operador').value || undefined
      };
      currentPage = 1;
      cargarTickets(1);
    });

    document.getElementById('btnLimpiar').addEventListener('click', () => {
      document.getElementById('filtro-desde').value = '';
      document.getElementById('filtro-hasta').value = '';
      document.getElementById('filtro-estado').value = '';
      document.getElementById('filtro-moneda').value = '';
      document.getElementById('filtro-mesa').value = '';
      document.getElementById('filtro-operador').value = '';
      currentFilters = {};
      currentPage = 1;
      cargarTickets(1);
    });

    document.getElementById('btnExportar').addEventListener('click', exportarReporte);
    document.getElementById('btnVerPDF').addEventListener('click', verPDF);
    document.getElementById('btnImprimirPDF').addEventListener('click', imprimirPDF);

    // Paginaci√≥n
    document.getElementById('btn-primera').addEventListener('click', () => cargarTickets(1));
    document.getElementById('btn-anterior').addEventListener('click', () => cargarTickets(currentPage - 1));
    document.getElementById('btn-siguiente').addEventListener('click', () => cargarTickets(currentPage + 1));
    document.getElementById('btn-ultima').addEventListener('click', () => cargarTickets(totalPages));

    // Volver al panel
    document.getElementById('btnVolver').addEventListener('click', () => {
      console.log('üîô Navegando de regreso al panel...');
      window.location.href = '../Caja/panel.html';
    });

    // ============================================
    // INICIALIZACI√ìN
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ [Frontend] M√≥dulo de Auditor√≠a iniciando...');
      console.log('üöÄ [Frontend] window.api disponible:', !!window.api);
      console.log('üöÄ [Frontend] window.api.invoke disponible:', !!(window.api && window.api.invoke));

      // ‚úÖ NO establecer fechas por defecto - buscar TODOS los tickets
      // Dejar los campos de fecha vac√≠os para que el usuario los configure si quiere filtrar
      console.log('üöÄ [Frontend] Cargando sin filtros de fecha (buscar todos)');

      // Cargar datos iniciales
      console.log('üöÄ [Frontend] Cargando estad√≠sticas y tickets iniciales...');
      cargarEstadisticas();
      cargarTickets(1);
    });

    // Sistema de salud anti-cuelgues: cargar indicador visual
    (async function cargarIndicadorSalud() {
      try {
        const response = await fetch('health-indicator.html');
        const html = await response.text();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        while (tempDiv.firstChild) {
          document.body.appendChild(tempDiv.firstChild);
        }
        console.log('‚úÖ Indicador de salud cargado');
      } catch (e) {
        console.warn('‚ùå No se pudo cargar indicador de salud:', e.message);
      }
    })();
  </script>
</body>
</html>
