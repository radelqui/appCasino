<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Casino - Panel Principal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-size: 48px;
        }

        h1 {
            color: white;
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 18px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .card-icon {
            font-size: 64px;
            margin-bottom: 20px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .card-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .card-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .card-button:hover {
            opacity: 0.9;
        }

        .mesa-card { --card-color: #28a745; }
        .caja-card { --card-color: #dc3545; }
        .reportes-card { --card-color: #ffc107; }
        .config-card { --card-color: #17a2b8; }

        /* Estado deshabilitado por rol */
        .card.disabled {
            opacity: 0.6;
            filter: grayscale(0.1);
        }
        .card.disabled .card-button {
            background: #bdbdbd;
            cursor: not-allowed;
        }
        .card.disabled::after {
            content: 'Acceso restringido por rol';
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            white-space: nowrap;
            z-index: 10;
        }
        .card.disabled:hover::after {
            opacity: 1;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 40px;
            display: flex;
            justify-content: space-around;
            backdrop-filter: blur(10px);
        }
        .status-bar.hidden { display: none !important; }

        .status-item {
            text-align: center;
            color: white;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
        }

        .status-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .connection-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .connection-indicator.offline {
            background: #dc3545;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        .shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .shortcut-item {
            margin: 5px 0;
        }

        .shortcut-key {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 3px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="connection-indicator" id="connectionStatus">
        <div class="pulse"></div>
        <span>Sistema Online</span>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
            <img src="file:///C:/appCasino/Dise√±o Ticket/logo casino.webp" alt="Logo Casino" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" onerror="this.src=this.dataset.fallback" data-fallback="https://via.placeholder.com/120?text=CASINO" />
            </div>
            <h1>CORAL REEF CASINO</h1>
            <div class="subtitle">Sistema de Gesti√≥n de Vouchers</div>
            <!-- Bot√≥n temporal de pruebas: limpiar BD -->
            <div style="margin-top:16px;">
              <button onclick="resetearBD()" style="background:#dc2626; color:white; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; box-shadow:0 4px 12px rgba(220,38,38,.35);">
                üóëÔ∏è LIMPIAR BD (PRUEBAS)
              </button>
            </div>
        </div>

        <div class="grid">
            <!-- Mesa -->
            <div class="card mesa-card" onclick="openView('mesa')">
                <div class="card-icon">üé∞</div>
                <div class="card-title">MESA</div>
                <div class="card-description">
                    Generaci√≥n de vouchers, emisi√≥n de tickets, 
                    impresi√≥n t√©rmica para operadores de mesa.
                </div>
                <button class="card-button">Abrir Mesa</button>
            </div>

            <!-- Caja -->
            <div class="card caja-card" onclick="openView('caja')">
                <div class="card-icon">üíµ</div>
                <div class="card-title">CAJA</div>
                <div class="card-description">
                    Validaci√≥n y cobro de vouchers, escaneo de QR, 
                    procesamiento de pagos.
                </div>
                <button class="card-button">Abrir Caja</button>
            </div>

            <!-- Reportes -->
            <div class="card reportes-card" onclick="openView('reportes')">
                <div class="card-icon">üìà</div>
                <div class="card-title">REPORTES</div>
                <div class="card-description">
                    Generar reportes y estad√≠sticas,
                    exportaci√≥n a Excel y PDF.
                </div>
                <button class="card-button">Abrir Reportes</button>
            </div>

            <!-- Configuraci√≥n -->
            <div class="card config-card" onclick="openView('config')">
                <div class="card-icon">‚öôÔ∏è</div>
                <div class="card-title">CONFIGURACI√ìN</div>
                <div class="card-description">
                    Ajustes del sistema, impresoras, base de datos,
                    sincronizaci√≥n y respaldos.
                </div>
                <button class="card-button">Configurar</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="ticketsHoy">0</div>
                <div class="status-label">Tickets Hoy</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="totalDOP">RD$ 0</div>
                <div class="status-label">Total DOP</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="totalUSD">$0</div>
                <div class="status-label">Total USD</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="horaActual">--:--</div>
                <div class="status-label">Hora Sistema</div>
            </div>
            <div class="status-item">
              <button id="logoutBtn" onclick="logoutAndPrompt()" style="padding:8px 12px; background:#ef4444; color:#fff; border:none; border-radius:8px; box-shadow:0 4px 10px rgba(239,68,68,.3);">Cerrar sesi√≥n</button>
            </div>
        </div>
    </div>

    <!-- Bloque de atajos eliminado permanentemente -->

    <!-- Modal Login Caja eliminado: acceso controlado por rol global -->

    <script>
        async function resetearBD(){
            try {
                if (!confirm('¬øSeguro que quieres ELIMINAR todos los tickets?')) return;
                const result = await (window.api?.resetDatabase?.() || window.api?.invoke?.('reset-database'));
                if (result?.success) {
                    alert('‚úÖ Base de datos limpiada');
                    try { await loadStats(); } catch {}
                    location.reload();
                } else {
                    alert('‚ùå Error: ' + (result?.error || 'Desconocido'));
                }
            } catch (e) {
                alert('‚ùå Error: ' + (e?.message || e));
            }
        }
        // Navegaci√≥n
        async function openView(view) {
            // Requiere sesi√≥n activa antes de navegar
            try {
                const session = await window.api?.getSession?.();
                if (!session || !session.user) { showLoginApp(); return; }
            } catch { showLoginApp(); return; }
        
            let role = 'MESA';
            try {
                const r = await (window.api?.getRole?.() ?? Promise.resolve('MESA'));
                role = String(r).toUpperCase();
            } catch (err) {
                console.warn('Fallo getRole, usando MESA por defecto:', err?.message || err);
                role = 'MESA';
            }
            // Reglas de acceso
            if (view === 'caja' && !(role === 'CAJA' || role === 'ADMIN')) {
                alert('Acceso restringido: solo Caja o Admin');
                return;
            }
            if (view === 'reportes' && !(role === 'AUDITOR' || role === 'ADMIN')) {
                alert('Acceso restringido: solo Auditor o Admin');
                return;
            }
            if (view === 'config' && !(role === 'ADMIN')) {
                alert('Acceso restringido: solo Admin');
                return;
            }
            switch(view) {
                case 'mesa':
                    window.api?.openView?.('mesa');
                    break;
                case 'caja':
                    // Pedimos al main abrir la ventana de Caja (preload espec√≠fico y validaci√≥n de DB)
                    window.api?.openView?.('caja');
                    break;
                case 'reportes':
                    window.api?.openView?.('reportes');
                    break;
                case 'config':
                    window.api?.openView?.('config');
                    break;
            }
        }

        // Atajos de teclado
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                switch(e.key.toLowerCase()) {
                    case 'm':
                        openView('mesa');
                        break;
                    case 'c':
                        openView('caja');
                        break;
                    case 'a':
                        openView('reportes');
                        break;
                }
            }
        });

        // Estado visual seg√∫n rol (sin ocultar, s√≥lo deshabilitar)
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('[panel] üîµ IIFE: Obteniendo rol...');

                // ‚ö° TIMEOUT: No esperar indefinidamente
                const timeoutPromise = new Promise((_, resolve) =>
                    setTimeout(() => { console.log('[panel] ‚è∞ IIFE getRole timeout'); resolve('MESA'); }, 2000)
                );

                let role = 'MESA'; // Rol por defecto
                try {
                    console.log('[panel] üîç IIFE: ANTES de Promise.race getRole');
                    role = String(await Promise.race([
                        window.api?.getRole?.(),
                        timeoutPromise
                    ])).toUpperCase();
                    console.log('[panel] üîç IIFE: DESPU√âS de Promise.race, rol:', role);
                } catch (roleError) {
                    console.warn('[panel] ‚ö†Ô∏è IIFE: getRole timeout, usando rol por defecto MESA');
                    role = 'MESA';
                }

                console.log('[panel] üîç IIFE: Buscando elementos del DOM...');
                const cajaCard = document.querySelector('.caja-card');
                const reportesCard = document.querySelector('.reportes-card');
                const configCard = document.querySelector('.config-card');
                console.log('[panel] üîç IIFE: Elementos encontrados:', {caja: !!cajaCard, reportes: !!reportesCard, config: !!configCard});

                cajaCard?.classList.toggle('disabled', !(role === 'CAJA' || role === 'ADMIN'));
                reportesCard?.classList.toggle('disabled', !(role === 'AUDITOR' || role === 'ADMIN'));
                configCard?.classList.toggle('disabled', !(role === 'ADMIN'));
                console.log('[panel] üîç IIFE: Cards actualizadas');

                // Privacidad: ocultar barra de estado a no auditores/admin
                const statusBar = document.querySelector('.status-bar');
                const canSeeGlobal = (role === 'AUDITOR' || role === 'ADMIN');
                statusBar?.classList.toggle('hidden', !canSeeGlobal);
                console.log('[panel] ‚úÖ IIFE: Estado visual actualizado completamente');
            } catch (e) {
                console.warn('[panel] ‚ùå Error en IIFE:', e.message);
            }
            console.log('[panel] üîç IIFE: TERMIN√ì la ejecuci√≥n');
        });

        // Actualizar hora
        function updateTime() {
            const now = new Date();
            document.getElementById('horaActual').textContent = 
                now.toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                console.log('[panel] üìä Cargando estad√≠sticas...');

                // ‚ö° TIMEOUT: No esperar indefinidamente
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Timeout esperando getStatsToday')), 2000)
                );

                let stats = null;
                try {
                    stats = await Promise.race([
                        window.api?.getStatsToday?.(),
                        timeoutPromise
                    ]);
                    console.log('[panel] ‚úÖ Estad√≠sticas obtenidas:', stats);
                } catch (statsError) {
                    console.warn('[panel] ‚ö†Ô∏è getStatsToday timeout, usando valores por defecto');
                }

                document.getElementById('ticketsHoy').textContent = stats?.ticketsHoy || 0;
                document.getElementById('totalDOP').textContent = `RD$ ${(stats?.totalDOP || 0).toFixed(2)}`;
                document.getElementById('totalUSD').textContent = `$${(stats?.totalUSD || 0).toFixed(2)}`;
            } catch (error) {
                console.error('[panel] ‚ùå Error cargando estad√≠sticas:', error);
                document.getElementById('ticketsHoy').textContent = 0;
                document.getElementById('totalDOP').textContent = `RD$ 0.00`;
                document.getElementById('totalUSD').textContent = `$0.00`;
            }
        }

        // Estado de conexi√≥n
        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionStatus');
            if (navigator.onLine) {
                indicator.classList.remove('offline');
                indicator.innerHTML = '<div class="pulse"></div><span>Sistema Online</span>';
            } else {
                indicator.classList.add('offline');
                indicator.innerHTML = '<div class="pulse"></div><span>Sistema Offline</span>';
            }
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        // Inicializar
        loadStats();
        updateConnectionStatus();

        // Login Caja removido: se usa login global y control de acceso por rol
    </script>

    <!-- Modal Login General -->
    <div id="loginAppModal" class="modal" style="display:none; position:fixed; inset:0; background:linear-gradient(135deg, rgba(30,60,114,.65), rgba(42,82,152,.65)); backdrop-filter: blur(3px); align-items:center; justify-content:center;">
      <div class="modal-content" style="background:#ffffff; padding:24px; border-radius:16px; width:400px; box-shadow:0 20px 50px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15); position:relative; overflow:hidden;">
        <div style="position:absolute; inset:0; pointer-events:none; opacity:.08; background: radial-gradient(circle at 20% 0%, #667eea, transparent 40%), radial-gradient(circle at 80% 100%, #764ba2, transparent 45%);"></div>
        <div style="position:relative;">
          <h3 style="margin:0 0 8px 0; font-size:22px; color:#2c3e50;">Bienvenido</h3>
          <p style="margin:0 0 16px 0; color:#6b7280; font-size:13px;">Inicia sesi√≥n para acceder al sistema</p>
          <div class="field" style="margin-bottom:12px;">
            <label style="display:block; font-size:12px; color:#6b7280; margin-bottom:6px;">Usuario</label>
            <input id="appUsername" placeholder="usuario@dominio" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; transition:border .2s;" onfocus="this.style.border='1px solid #667eea'" onblur="this.style.border='1px solid #e5e7eb'" />
          </div>
          <div class="field">
            <label style="display:block; font-size:12px; color:#6b7280; margin-bottom:6px;">Contrase√±a</label>
            <input id="appPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; transition:border .2s;" onfocus="this.style.border='1px solid #667eea'" onblur="this.style.border='1px solid #e5e7eb'" />
          </div>
          <div style="display:flex; gap:10px; margin-top:16px;">
            <button id="btnLoginApp" onclick="attemptLoginApp()" style="flex:1; padding:10px 14px; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; border:none; border-radius:10px; box-shadow:0 6px 14px rgba(118,75,162,.3);">Ingresar</button>
            <button onclick="exitApp()" style="padding:10px 14px; background:#ffffff; color:#374151; border:1px solid #e5e7eb; border-radius:10px;">Salir</button>
          </div>
          <p id="loginAppError" class="muted" style="color:#c0392b; display:none; margin-top:10px; font-size:12px;">Error de autenticaci√≥n</p>
          <div style="margin-top:14px; color:#6b7280; font-size:11px;">
            <span>Autenticaci√≥n requerida para continuar.</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function checkSessionAndPrompt(){
        console.log('[panel] üîµ checkSessionAndPrompt called');
        try {
          console.log('[panel] window.api available:', !!window.api);

          // ‚ö° TIMEOUT: No esperar indefinidamente por handlers que pueden no existir
          const timeoutPromise = new Promise((_, resolve) =>
            setTimeout(() => { console.log('[panel] ‚è∞ getSession timeout'); resolve(null); }, 2000)
          );

          let session = null;
          try {
            console.log('[panel] üîç ANTES de Promise.race getSession');
            session = await Promise.race([
              window.api?.getSession?.(),
              timeoutPromise
            ]);
            console.log('[panel] üîç DESPU√âS de Promise.race getSession, result:', session);
          } catch (sessionError) {
            console.warn('[panel] ‚ö†Ô∏è getSession timeout o error:', sessionError.message);
            // Continuar sin sesi√≥n (mostrar login)
          }

          console.log('[panel] üîç Verificando si session && session.user:', !!session, !!(session?.user));
          if (session && session.user) {
            // Intentar obtener rol con timeout tambi√©n
            console.log('[panel] üîç ENTR√ì en bloque de obtener rol');
            try {
              const roleTimeoutPromise = new Promise((_, resolve) =>
                setTimeout(() => { console.log('[panel] ‚è∞ getRole timeout'); resolve('MESA'); }, 2000)
              );
              console.log('[panel] üîç ANTES de Promise.race getRole');
              const currentRole = await Promise.race([
                window.api?.getRole?.(),
                roleTimeoutPromise
              ]);
              console.log('[panel] üîç DESPU√âS de Promise.race getRole, currentRole:', currentRole);
              console.log('[panel] üîç ANTES de updateRoleUI');
              updateRoleUI(currentRole);
              console.log('[panel] üîç DESPU√âS de updateRoleUI');
            } catch (roleError) {
              console.warn('[panel] ‚ö†Ô∏è getRole timeout o error:', roleError.message);
              // Usar rol por defecto
              console.log('[panel] üîç getRole fall√≥, usando MESA por defecto');
              updateRoleUI('MESA');
            }
          } else {
            // Si no hay sesi√≥n activa, pedir credenciales
            console.log('[panel] üîç NO hay sesi√≥n, mostrando login modal');
            showLoginApp();
            console.log('[panel] üîç DESPU√âS de showLoginApp');
          }
        } catch(e){
          console.warn('[panel] ‚ùå checkSession error:', e);
          // En caso de error al obtener sesi√≥n, pedir login
          showLoginApp();
        }
        console.log('[panel] ‚úÖ checkSessionAndPrompt completed');
      }
      function showLoginApp(){
        console.log('[panel] üîç showLoginApp INICIO');
        const m = document.getElementById('loginAppModal');
        console.log('[panel] üîç loginAppModal element:', !!m);
        if (m) {
          m.style.display = 'flex';
          console.log('[panel] üîç Modal display set to flex');
        }
        const u = document.getElementById('appUsername');
        const p = document.getElementById('appPassword');
        if (u) u.value = '';
        if (p) p.value = '';
        const err = document.getElementById('loginAppError');
        if (err) { err.style.display='none'; err.textContent=''; }
        console.log('[panel] üîç showLoginApp COMPLETADO');
      }
      function hideLoginApp(){
        console.log('[panel] hideLoginApp');
        const m = document.getElementById('loginAppModal');
        if (m) m.style.display = 'none';
      }
      async function attemptLoginApp(){
        try {
          console.log('[panel] attemptLoginApp');
          const btn = document.getElementById('btnLoginApp');
          if (btn) { btn.disabled = true; btn.textContent = 'Ingresando...'; }
          const username = document.getElementById('appUsername')?.value;
          const password = document.getElementById('appPassword')?.value;
          console.log('[panel] invoking window.api.loginApp with:', { username, passwordPresent: !!password });
          console.log('[panel] window.api.loginApp exists:', !!(window.api?.loginApp));
          const res = await window.api?.loginApp?.(username, password);
          console.log('[panel] loginApp result:', res);
          if (res && res.success){
            hideLoginApp();
            // Actualizar UI seg√∫n rol y redirigir si es MESA
            try {
              const role = String(res?.user?.role || (await window.api?.getRole?.()) || 'MESA').toUpperCase();
              console.log('[panel] role after login:', role);
              updateRoleUI(role);
              if (role === 'MESA') {
                try { openView('mesa'); } catch {}
              }
            } catch{}
          } else {
            const err = document.getElementById('loginAppError');
            if (err){ err.textContent = res?.error || 'Error de autenticaci√≥n'; err.style.display='block'; }
          }
        } catch(e){
          console.error('[panel] attemptLoginApp error:', e);
          const err = document.getElementById('loginAppError');
          if (err){ err.textContent = e?.message || String(e); err.style.display='block'; }
        } finally {
          const btn = document.getElementById('btnLoginApp');
          if (btn) { btn.disabled = false; btn.textContent = 'Ingresar'; }
        }
      }
      function updateRoleUI(role){
        console.log('[panel] üîç updateRoleUI called with role:', role);
        // Si ya existe l√≥gica para ocultar/mostrar tarjetas por rol, reutil√≠zala
        try {
          const r = String(role||'MESA').toUpperCase();
          console.log('[panel] üîç updateRoleUI normalized role:', r);
          // ejemplo: document.querySelector('#cardCaja')?.classList.toggle('hidden', !(r==='CAJA'||r==='ADMIN'));
        } catch (e) {
          console.error('[panel] üîç updateRoleUI error:', e);
        }
        console.log('[panel] üîç updateRoleUI completed');
      }
      async function exitApp(){
        console.log('[panel] exitApp - Cerrando aplicaci√≥n');
        try {
          await window.api?.invoke?.('exit-app');
        } catch(e) {
          console.error('[panel] Error cerrando app:', e);
        }
      }
      document.addEventListener('DOMContentLoaded', checkSessionAndPrompt);

      async function logoutAndPrompt(){
        try { await window.api?.logout?.(); } catch(e) {}
        try { updateRoleUI('MESA'); } catch {}
        showLoginApp();
      }
      try { window.api?.onLogoutRequest?.(() => logoutAndPrompt()); } catch {}
    </script>
</body>
</html>
